<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>AI Agent Dashboard with CSV + Chart + AI Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    /* Custom scrollbar for chat */
    #chatWindow::-webkit-scrollbar {
      width: 8px;
      background: #f3f4f6;
    }
    #chatWindow::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 4px;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-gray-100 min-h-screen font-sans">

  <main class="p-6 max-w-6xl mx-auto mt-10">
    <h1 class="text-3xl font-extrabold text-gray-800 mb-8 flex items-center gap-2">
      <span>üìà</span> Business Dashboard
    </h1>

    <!-- KPI Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-6 mb-12">
      <div id="meatCard" class="transition transform hover:scale-105 bg-white p-6 rounded-xl shadow flex flex-col items-center">
        <span class="text-3xl mb-2 text-red-500">ü•©</span>
        <h2 class="text-lg font-semibold text-gray-700">Meat Stock</h2>
        <p id="meatStock" class="mt-2 text-gray-600 text-xl font-bold">--</p>
      </div>
      <div id="flourCard" class="transition transform hover:scale-105 bg-white p-6 rounded-xl shadow flex flex-col items-center">
        <span class="text-3xl mb-2 text-yellow-500">üåæ</span>
        <h2 class="text-lg font-semibold text-gray-700">Flour Stock</h2>
        <p id="flourStock" class="mt-2 text-gray-600 text-xl font-bold">--</p>
      </div>
      <div id="revenueCard" class="transition transform hover:scale-105 bg-white p-6 rounded-xl shadow flex flex-col items-center">
        <span class="text-3xl mb-2 text-green-500">üí∞</span>
        <h2 class="text-lg font-semibold text-gray-700">Revenue</h2>
        <p id="revenue" class="mt-2 text-gray-600 text-xl font-bold">--</p>
      </div>
      <div id="expensesCard" class="transition transform hover:scale-105 bg-white p-6 rounded-xl shadow flex flex-col items-center">
        <span class="text-3xl mb-2 text-pink-500">üí∏</span>
        <h2 class="text-lg font-semibold text-gray-700">Expenses</h2>
        <p id="expenses" class="mt-2 text-gray-600 text-xl font-bold">--</p>
      </div>
      <div id="productionCard" class="transition transform hover:scale-105 bg-white p-6 rounded-xl shadow flex flex-col items-center">
        <span class="text-3xl mb-2 text-blue-500">üè≠</span>
        <h2 class="text-lg font-semibold text-gray-700">Production</h2>
        <p id="production" class="mt-2 text-gray-600 text-xl font-bold">--</p>
      </div>
    </div>

    <!-- Chart -->
    <div class="bg-white p-8 rounded-xl shadow mb-12">
      <h2 class="text-2xl font-semibold mb-6 flex items-center gap-2">üìä Revenue & Expenses (Last 7 Days)</h2>
      <canvas id="financeChart" height="120"></canvas>
    </div>

    <!-- AI Agent Chatbox -->
    <div class="bg-white p-8 rounded-xl shadow">
      <h2 class="text-2xl font-semibold mb-4 flex items-center gap-2">ü§ñ AI Agent Chat</h2>
      <div id="chatWindow" class="h-72 overflow-y-auto border border-gray-200 p-4 mb-4 rounded-lg bg-gray-50 transition-all"></div>
      <label for="userInput" class="sr-only">Type your message</label>
      <textarea id="userInput" class="w-full border border-gray-300 rounded-lg p-3 mb-3 focus:ring-2 focus:ring-blue-400 transition" rows="3" placeholder="Type your message here..."></textarea>
      <button id="sendBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 transition">Send</button>
    </div>
  </main>

  <script>
    // CSV + Chart code
    document.addEventListener("DOMContentLoaded", function () {
      const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTrqB3aE-D19ORDD5MPoYF3EDLXNZuRgJzql3idB6wpB2w73X69Vb_Kx2zrQ_RFt2SdNBDZAllggRbV/pub?gid=0&single=true&output=csv';

      Papa.parse(sheetURL, {
        download: true,
        header: true,
        complete: function (results) {
          const data = results.data;
          if (!data || data.length < 2) return;
          const latest = data[data.length - 2]; // skip empty last row

          // KPIs
          document.getElementById("meatStock").innerText = `${latest.Meat_Stock} units`;
          document.getElementById("flourStock").innerText = `${latest.Flour_Stock} kg`;
          document.getElementById("revenue").innerText = `$${Number(latest.Revenue).toLocaleString()}`;
          document.getElementById("expenses").innerText = `$${Number(latest.Expenses).toLocaleString()}`;
          document.getElementById("production").innerText = `${latest.Production_Output} items`;

          // Color alerts
          const meat = parseInt(latest.Meat_Stock);
          const flour = parseInt(latest.Flour_Stock);
          const revenue = parseFloat(latest.Revenue);
          const expenses = parseFloat(latest.Expenses);

          const meatCard = document.getElementById("meatCard");
          const flourCard = document.getElementById("flourCard");
          const revenueCard = document.getElementById("revenueCard");
          const expensesCard = document.getElementById("expensesCard");

          meat < 20 ? meatCard.classList.add("ring-2", "ring-red-300") : meatCard.classList.remove("ring-2", "ring-red-300");
          flour < 30 ? flourCard.classList.add("ring-2", "ring-yellow-300") : flourCard.classList.remove("ring-2", "ring-yellow-300");
          revenue < 10000 ? revenueCard.classList.add("ring-2", "ring-red-300") : revenueCard.classList.remove("ring-2", "ring-red-300");
          expenses > 5000 ? expensesCard.classList.add("ring-2", "ring-red-300") : expensesCard.classList.remove("ring-2", "ring-red-300");

          // Chart setup (last 7 days)
          const last7 = data.slice(-8, -1);
          const dates = last7.map(r => r.Date);
          const revenues = last7.map(r => parseFloat(r.Revenue));
          const expensesData = last7.map(r => parseFloat(r.Expenses));

          const ctx = document.getElementById('financeChart').getContext('2d');
          new Chart(ctx, {
            type: 'line',
            data: {
              labels: dates,
              datasets: [
                {
                  label: 'Revenue',
                  data: revenues,
                  backgroundColor: 'rgba(34,197,94,0.08)',
                  borderColor: 'rgba(34,197,94,1)',
                  pointBackgroundColor: 'rgba(34,197,94,1)',
                  borderWidth: 3,
                  pointRadius: 4,
                  fill: true,
                  lineTension: 0.3
                },
                {
                  label: 'Expenses',
                  data: expensesData,
                  backgroundColor: 'rgba(239,68,68,0.08)',
                  borderColor: 'rgba(239,68,68,1)',
                  pointBackgroundColor: 'rgba(239,68,68,1)',
                  borderWidth: 3,
                  pointRadius: 4,
                  fill: true,
                  lineTension: 0.3
                }
              ]
            },
            options: {
              responsive: true,
              legend: { labels: { fontSize: 16 } },
              scales: {
                yAxes: [{
                  ticks: {
                    beginAtZero: true,
                    fontSize: 14
                  }
                }],
                xAxes: [{
                  ticks: {
                    fontSize: 14
                  }
                }]
              },
              animation: {
                duration: 1200,
                easing: 'easeOutQuart'
              }
            }
          });
        }
      });
    });

    // AI Chatbox code
    const chatWindow = document.getElementById('chatWindow');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');

    function appendMessage(sender, text) {
      const messageElem = document.createElement('div');
      messageElem.className = sender === 'user'
        ? 'flex justify-end mb-2'
        : 'flex justify-start mb-2';
      messageElem.innerHTML = `
        <span class="inline-block max-w-xs px-4 py-2 rounded-2xl shadow
          ${sender === 'user'
            ? 'bg-blue-600 text-white rounded-br-none'
            : 'bg-gray-200 text-gray-800 rounded-bl-none'}">
          ${text}
        </span>`;
      chatWindow.appendChild(messageElem);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    async function sendMessage() {
      const message = userInput.value.trim();
      if (!message) return;

      appendMessage('user', message);
      userInput.value = '';
      userInput.focus();
      appendMessage('agent', '<span class="italic text-gray-500">...typing</span>');

      try {
        // Replace with your AI backend endpoint
        const response = await fetch('/.netlify/functions/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt: message })
        });

        const data = await response.json();

        // Remove the '...typing' message before adding real response
        const typingElem = chatWindow.querySelector('div:last-child');
        if (typingElem && typingElem.innerText.includes('...typing')) {
          chatWindow.removeChild(typingElem);
        }

        appendMessage('agent', data.response || '<span class="italic text-gray-400">Sorry, no response.</span>');
      } catch (error) {
        const typingElem = chatWindow.querySelector('div:last-child');
        if (typingElem && typingElem.innerText.includes('...typing')) {
          chatWindow.removeChild(typingElem);
        }
        appendMessage('agent', `<span class="text-red-600">Error: ${error.message}</span>`);
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
  </script>
</body>
</html>
