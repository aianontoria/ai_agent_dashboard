// Floating Chat Widget Logic
(() => {
  const chatToggle = document.getElementById("chat-toggle");
  const chatPopup = document.getElementById("chat-popup");
  const chatClose = document.getElementById("chat-close");
  const chatForm = document.getElementById("chat-form");
  const chatInput = document.getElementById("chat-input");
  const chatMessages = document.getElementById("chat-messages");

  // Toggle chat popup visibility
  chatToggle.addEventListener("click", () => {
    chatPopup.style.display = chatPopup.style.display === "flex" ? "none" : "flex";
    chatInput.focus();
  });
  chatClose.addEventListener("click", () => {
    chatPopup.style.display = "none";
  });

  // Append message to chat window
  function appendMessage(text, sender = "bot") {
    const msgDiv = document.createElement("div");
    msgDiv.className = `message ${sender}`;
    msgDiv.textContent = text;
    chatMessages.appendChild(msgDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Send message to Deepseek API
  async function sendMessage(message) {
    appendMessage(message, "user");

    try {
      const response = await fetch("https://api.deepseek.com/v1/chat/completions", {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "Authorization": "Bearer sk-free" // Free tier key
        },
        body: JSON.stringify({
          model: "deepseek-chat",
          messages: [
            {
              role: "user",
              content: message
            }
          ],
          temperature: 0.7,
          max_tokens: 2000
        }),
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      const aiResponse = data.choices[0]?.message?.content || "Sorry, I couldn't process that request.";

      appendMessage(aiResponse, "bot");
    } catch (err) {
      console.error("Chat error:", err);
      appendMessage("Sorry, I'm having trouble connecting to the AI service. Please try again later.", "bot");
    }
  }

  chatForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const msg = chatInput.value.trim();
    if (!msg) return;
    chatInput.value = "";
    sendMessage(msg);
  });
})();
